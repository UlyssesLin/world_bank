<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8">
<style>

body {
  font: 18px Arial;
}

p {
  margin: 0;
}
#waffle {
  margin-bottom: 30px;
}

#legend {
  font: 13px Arial;
}

</style>
</head>

<body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<div id="title">
  <p>Division for male and female in workforce by working sectors</p>
</div>
<br>
<p>Female</p>
<div id="waffleFemale">
</div>
<p>Male</p>
<div id="waffleMale">
</div>
<div id="legend">
</div>
</body>

<script>
//var color_scheme = ["#FCB583","#36E2BD", "	#36E2BD"];
var total = 0;
var width,
    height,
    widthSquares = 10,
    heightSquares = 10,
    squareSize = 25,
    squareValue = 0,
    gap = 1,
    theDataFemale = [],
    theDataMale = [];
    
var defaultCountry = "Japan";
var defaultYear = "2012"; 

var color = d3.scale.category10();

// Code block for Women

d3.csv("https://raw.githubusercontent.com/UlyssesLin/world_bank/wafflechart/VA_wafflechart_new/waffle_Wrangled.csv", function(error, data)
{
    data = data.filter(function(row) {
    return row['country'] == defaultCountry && row['year'] == defaultYear;
})
  
    //total
  total = d3.sum(data, function(d) { return d.womenPercents; });

  //value of a square
  squareValue = total / (widthSquares*heightSquares);
  
  //remap data
  data.forEach(function(d, i) 
  {
      d.womenPercents = +d.womenPercents;
      d.units = Math.floor(d.womenPercents/squareValue);
      theDataFemale = theDataFemale.concat(
        Array(d.units+1).join(1).split('').map(function()
          {
            return {  squareValue:squareValue,                      
                      units: d.units,
                      womenPercents: d.womenPercents,
                      groupIndex: i
                    };
          })
        );
  });

  width = (squareSize*widthSquares) + widthSquares*gap + 25;
  height = (squareSize*heightSquares) + heightSquares*gap + 25;

  var waffle = d3.select("#waffleFemale")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .selectAll("div")
    .data(theDataFemale)
    .enter()
    .append("rect")
    .attr("width", squareSize)
    .attr("height", squareSize)
    .attr("fill", function (d) {
      return color(d.groupIndex);
    })
    .attr("x", function (d, i) {
      //group n squares for column
      col = Math.floor(i / heightSquares);
      return (col * squareSize) + (col * gap);
    })
    .attr("y", function (d, i) {
      row = i % heightSquares;
      return (heightSquares * squareSize) - ((row * squareSize) + (row * gap))
    })
    .append("title")
    .text(function (d, i) {
      return "Sectors: " + data[d.groupIndex].womenJobCategory + " | " + d.units + "%"
    });

  //add legend with categorical data
  var legend = d3.select("#legend")
    .append("svg")
    .attr('width', 300)
    .attr('height', 200)
    .append('g')
    .selectAll("div")
    .data(data)
    .enter()
    .append("g")
    .attr('transform', function (d, i) { return "translate(0," + i * 20 + ")"; });
  legend.append("rect")
    .attr("width", 18)
    .attr("height", 18)
    .style("fill", function (d, i) { return color(i) });
  legend.append("text")
    .attr("x", 25)
    .attr("y", 13)
    .text(function (d) { return d.womenJobCategory });

  //add value of a unit square
  var legend2 = d3.select("#legend")
    .select('svg')
    .append('g')
    .attr('transform', "translate(100,0)");

    legend2.append("text")
        .attr('y', '14')
        .attr('font-size', '18px')
        .attr("fill", "#444444"); 
});

  // Code block for Men
  d3.csv("https://raw.githubusercontent.com/UlyssesLin/world_bank/wafflechart/VA_wafflechart_new/waffle_Wrangled.csv", function (error, data) {

    data = data.filter(function (row) {
      return row['country'] == defaultCountry && row['year'] == defaultYear;
    })

    //total
    total = d3.sum(data, function (d) { return d.menPercents; });

    //value of a square
    squareValue = total / (widthSquares * heightSquares);

    //remap data
    data.forEach(function (d, i) {
      d.menPercents = +d.menPercents;
      d.units = Math.floor(d.menPercents / squareValue);
      theDataMale = theDataMale.concat(
        Array(d.units + 1).join(1).split('').map(function () {
          return {
            squareValue: squareValue,
            units: d.units,
            menPercents: d.menPercents,
            groupIndex: i
          };
        })
      );
    });

    width = (squareSize * widthSquares) + widthSquares * gap + 25;
    height = (squareSize * heightSquares) + heightSquares * gap + 25;

    var waffle = d3.select("#waffleMale")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .selectAll("div")
      .data(theDataMale)
      .enter()
      .append("rect")
      .attr("width", squareSize)
      .attr("height", squareSize)
      .attr("fill", function (d) {
        return color(d.groupIndex);
      })
      .attr("x", function (d, i) {
        //group n squares for column
        col = Math.floor(i / heightSquares);
        return (col * squareSize) + (col * gap);
      })
      .attr("y", function (d, i) {
        row = i % heightSquares;
        return (heightSquares * squareSize) - ((row * squareSize) + (row * gap))
      })
      .append("title")
      .text(function (d, i) {
        return "Sectors: " + data[d.groupIndex].menJobCategory + " | " + d.units + "%"
      });
  });
</script>
</html>